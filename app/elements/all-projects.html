<dom-module id='all-projects'>

  <template>
    <style>
      :host{
        display: block;
      }

      :host([active]) {
        display: block;
      }

      .project-info {
        background-color: #fff;
        padding: 16px;
      }

      .project-info__title {

      }

      .project-list {
        margin-top: -16px;
      }

      .project-list__item {
        opacity: 0;
        transition: all .175s ease-in;
        transform: translateX(-16px);
      }

      .project-list__item.is-hidden {
        display: none;
      }

      .project-list:not(.is-loaded) .project-list__item {
        /* used !important to override style attribute */
        transition-delay: 0s !important;
      }

      .project-list.is-loaded .project-list__item {
        opacity: 1;
        transform: translateX(0);
      }

      .project-filter {
        display: flex;
        align-items: center;
        justify-content: flex-end;
      }

      .project-filter.is-hidden {
        display: none;
      }

      .page--yellow paper-range-slider {
        --paper-range-slider-active-color: #ffcc33;
        --paper-range-slider-pin-color: #ffcc33;
        --paper-range-slider-knob-color: #ffcc33;
      }
      .page--yellow paper-dropdown-menu {
        --primary-color: #ffcc33;
      }

      .page--red paper-range-slider {
        --paper-range-slider-active-color: #ff3366;
        --paper-range-slider-pin-color: #ff3366;
        --paper-range-slider-knob-color: #ff3366;
      }
      .page--red paper-dropdown-menu {
        --primary-color: #ff3366;
      }

      .page--green paper-range-slider {
        --paper-range-slider-active-color: #66cc66;
        --paper-range-slider-pin-color: #66cc66;
        --paper-range-slider-knob-color: #66cc66;
      }
      .page--green paper-dropdown-menu {
        --primary-color: #66cc66;
      }

      .page--blue paper-range-slider {
        --paper-range-slider-active-color: #33cccc;
        --paper-range-slider-pin-color: #33cccc;
        --paper-range-slider-knob-color: #33cccc;
      }
      .page--blue paper-dropdown-menu {
        --primary-color: #33cccc;
      }

    </style>

    <firebase-document
      app-name="test"
      path="content"
      data="{{content}}">
    </firebase-document>

    <firebase-document
      app-name="test"
      path="{{ location }}"
      data="{{ projectsData }}">
    </firebase-document>

    <div class$='page {{ _getColorClass(selected) }}'>
      <hello-all-projects all_projects_cloud_content="{{content.all_projects_cloud_content}}"></hello-all-projects>
      <div class="page__content">
        <div class="mdl-grid">
          <div class="content-column mdl-cell mdl-cell--3-col mdl-cell--4-col-tablet mdl-cell--4-col-phone">
            <project-card selected={{selected}} content="{{content.youth_engagement}}" phrase='Products For Youth' fb='ureport' svg="youth_engagement" rgb='255, 204, 51, 0.2'></project-card>
          </div>
          <div class="content-column mdl-cell mdl-cell--3-col mdl-cell--4-col-tablet mdl-cell--4-col-phone">
            <project-card selected={{selected}} content="{{content.real_time_info}}" phrase='Real-time Information' svg="real_time_information" rgb='255, 204, 51, 0.2'></project-card>
          </div>
          <div class="content-column mdl-cell mdl-cell--3-col mdl-cell--4-col-tablet mdl-cell--4-col-phone">
            <project-card selected={{selected}} content="{{content.infrastructure}}" phrase='Infrastructure' fb='iogt'  svg="infrastructure"   rgb='255, 204, 51, 0.2'></project-card>
          </div>
          <div class="content-column mdl-cell mdl-cell--3-col mdl-cell--4-col-tablet mdl-cell--4-col-phone">
            <project-card selected={{selected}} content="{{content.knowledge_p}}" phrase='Knowledge Products' fb='iogt'  svg="knowledge_products"   rgb='255, 204, 51, 0.2'></project-card>
          </div>
          <div class="project-info mdl-cell mdl-cell--12-col mdl-shadow--4dp">
            <div class="mdl-grid mdl-grid--no-spacing">
              <div class="mdl-cell--4-col mdl-cell">
                <h2 class="project-info__value">{{ _getProjectInfoValue(projects) }}</h2>
              </div>
              <div class="mdl-layout-spacer"></div>
              <div class$="project-filter project-filter--yellow mdl-cell--4-col mdl-cell {{ _showFiltersClass(projects) }}">

                <!-- amount filter -->
                <paper-dropdown-menu class="project-filter__menu" label="Amount" on-paper-dropdown-close="_amountFilterClosed">
                  <paper-listbox id="amountFilterListbox" class="dropdown-content">
                    <paper-item>${{ filterAmountMin }}-${{ filterAmountMax }}</paper-item>
                    <paper-item on-tap="_onAmountFilterTap">
                      <paper-range-slider class="slider" id="amountFilter" step='10000'></paper-range-slider>
                    </paper-item>
                  </paper-listbox>
                </paper-dropdown-menu>
                <!-- amount filter -->

              </div>
            </div>
          </div>
        </div>
        <div class="project-list mdl-grid">
          <template is="dom-repeat" id='templateProjects' items="{{projects}}">
              <portfolio-project class$="project-list__item mdl-cell mdl-cell--3-col mdl-cell--4-col-tablet mdl-cell--4-col-phone {{ _getFilterClass(item, filterAmountMin, filterAmountMax) }}" data={{projectsData}} index={{index}} svg={{selected}} item={{item}}></portfolio-project>
          </template>
        </div>
      </div>
    </div>
  </template>
</dom-module>
<script>

  var projectCards = [
    { label: 'Products For Youth', key: 'youth_engagement', svg: 'youth_engagement' },
    { label: 'Real-time Information', key: 'real_time_info', svg: 'real_time_information' },
    { label: 'Infrastructure', key: 'infrastructure', svg: 'infrastructure' },
    { label: 'Knowledge Products', key: 'knowledge_p', svg: 'knowledge_products' }
  ];

  Polymer({
    is: 'all-projects',
    properties: {
      selected: {
        type: String,
        value: projectCards[0].key,
        notify: true,
        observer: '_selectedChange'
      },
      svg: {
        value: '',
        notify: true
      },
      url: {
        value: '/stats'
      },
      active: {
        type: Boolean,
        value: false,
        reflectToAttribute: true
      },
      location: {
        type: String,
        computed: '_computeLocation(selected)'
      },
      projectsData:{
        type: Object,
        observer: '_assignProjects'
      },
      projects: {
        type: Array
      },
      projectCards: {
        type: Array,
        value: projectCards
      },
      filterAmountMin: {
        type: Number,
        value: null
      },
      filterAmountMax: {
        type: Number,
        value: null
      }
    },

    ready: function(){
      var stagger = 25;
      var projectList = this.querySelector('.project-list');

      this.$.templateProjects.addEventListener('dom-change', (function(){
        var projectItems = this.querySelectorAll('.project-list__item');
        projectItems.forEach(function(item, key){
          item.style.transitionDelay = (key*stagger)+'ms';
        });

        //This line is used to force DOM redraw
        $(projectList).hide().show(0);

        projectList.classList.add('is-loaded');
      }).bind(this));

      this._initFilters();
    },

    _assignProjects: function(obj, oldObj){
      if(Object.keys(obj).length > 0){
        //Used to stagger item transition
        var projectList = this.querySelector('.project-list');
        projectList.classList.remove('is-loaded');

        this._setAmountMinMax(obj);

        //Timeout waits for transition to finish
        setTimeout((function(){
          this.projects = obj;
        }).bind(this), 350);
      }
    },

    _financial: function(data, kind){
      return [data.totals[kind], data.spents[kind]]
    },

    _computeLocation: function(route) {
       return "portfolios/" + route + '/projects';
    },

    _getProjectInfoValue(projects) {
      if (!projects.length) {
        return '';
      }
      return projects.length + ' project' + (projects.length > 1 ? 's' : '');
    },

    _getProjectContent(content, key) {
      return content[key];
    },

    _initFilters() {
      this.$.amountFilter.addEventListener('updateValues', (function(e){
        this.filterAmountMin = this.$.amountFilter.valueMin;
        this.filterAmountMax = this.$.amountFilter.valueMax;
        this.$.amountFilterListbox.select(null);
      }).bind(this));
    },

    _amountFilterClosed(e) {
      if (this.filterAmountMin && this.filterAmountMax) {
        this.$.amountFilterListbox.selectIndex(0);
      }
    },

    _onAmountFilterTap(e) {
      e.preventDefault();
      e.stopPropagation();
      return false;
    },

    _setAmountMinMax(elements) {
      var values = elements.map((function(item){
        return this._getIntFromAmount(item.amount);
      }).bind(this));

      var min = Math.min.apply(null, values);
      var max = Math.max.apply(null, values);

      //Dividing by 1000 to assure slider is working properly
      this.$.amountFilter.setMin(min);
      this.$.amountFilter.setMax(max);
      this.$.amountFilter.setValues(min,max);

      this.filterAmountMin = min;
      this.filterAmountMax = max;
      this.$.amountFilterListbox.select(null);
    },

    _getIntFromAmount(value) {
      return parseInt(value.replace(/\$|\,/g, ''));
    },

    _getColorClass(selected) {
      switch (selected) {
        case 'real_time_information':
          return 'page--red';
        case 'infrastructure':
          return 'page--green';
        case 'knowledge_products':
          return 'page--blue';
        default:
          return 'page--yellow';
      }
    },

    _selectedChange(e) {
      this.querySelectorAll('.project-filter__menu, .slider').forEach(function(item){
        item.updateStyles();
      });
    },

    _showFiltersClass(projects) {
      if (projects && projects.length > 1) {
        return '';
      }
      return 'is-hidden';
    },

    _getFilterClass(item, filterAmountMin, filterAmountMax) {
      var amount = this._getIntFromAmount(item.amount);
      if ((filterAmountMin && filterAmountMax) && (amount < filterAmountMin || amount > filterAmountMax)) {
        return 'is-hidden';
      }
      return '';
    }
  })
</script>
