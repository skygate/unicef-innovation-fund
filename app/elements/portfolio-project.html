<dom-module id='portfolio-project'>
  <template>
    <style>

      :host {
        background-color: #fff;
        display: inline-block;
        width: 100%;
        position: relative;
        transition: all .175s ease-in;
        margin-bottom: 0;
        height: 130px;
        --portfolio-project-expanded-height: 616px;
        position: relative;
        bottom: 0;

      }

      :host.is-expanded {
        bottom: -16px;
      }

      ul{
        list-style: none;
      }

      .portfolio-project__content {
        line-height: 1.5;
        height: 100%;
      }

      .portfolio-project__container {
        transition: box-shadow .175s ease-in;
        cursor: pointer;
        height: 100%;
      }

      .portfolio-project__sub-text {
        color:gray;
      }

      .portfolio-project__name {
        text-align: left;
        margin: 0;
        padding: 0;
      }

      .portfolio-project__content {
        padding: 32px 16px;
      }

      .portfolio-project__icon {
        position: absolute;
        top: 17px;
        right: 16px;
        opacity: 0;
        transition: opacity .175s ease-out;
      }

      :host:hover .portfolio-project__icon {
        opacity: 1;
      }

    </style>

    <div class-name='divider divider--{{svg}} portfolio-project__container mdl-shadow--4dp' on-tap="_handleTap" on-mouseenter='_onMouseEnter' on-mouseleave='_onMouseLeave'>
      <div class="portfolio-project__content">
        <div class="portfolio-project__icon">
          <i class="material-icons">&#xE56B;</i>
        </div>
        <div class='portfolio-project__name'>
          <span data-page="{{svg}}"><b>{{item.name}}</b></span>
        </div>
        <div class='portfolio-project__sub-text'>
          {{item.country}}
        </div>
        <div class='portfolio-project__sub-text'>
          {{to_mil(item.amount)}}
        </div>
      </div>
    </div>

  </template>
</dom-module>

<script>

  Polymer({
    is: 'portfolio-project',

    properties: {
      svg: {
        value: '',
        notify: true
      }
    },

    to_mil: function(num){
      return(cleanToMil(num.replace(/\$|,/g, '')))
    },

    _onMouseEnter: function(e) {
      this.$$('.portfolio-project__container').classList.add('mdl-shadow--8dp');
    },

    _onMouseLeave: function(e) {
      this.$$('.portfolio-project__container').classList.remove('mdl-shadow--8dp');
    },

    _handleTap: function(e){
      var that = this;
      var projectViewContainer = document.querySelector('#projectListProjectViewContainer');

      if (!this.classList.contains('is-expanded')) {
        var expandedProjects = document.querySelectorAll('portfolio-project.is-expanded');
        if (expandedProjects && expandedProjects.length) {
          var count = 0;
          for(var i = 0; i < expandedProjects.length; i++){
            var project = expandedProjects[i];
            project.deactivate(function(){
              count++;
              if (count == expandedProjects.length) {
                that.expandProjectView(that);
              }
            });
          }
        } else {
          this.expandProjectView(this);
        }

      } else {
        this.deactivate();
      }
    },
    deactivate: function(callback) {
      var projectViewContainer = document.querySelector('#projectListProjectViewContainer');
      var projectView = document.querySelector('#projectListProjectView');
      projectViewContainer.classList.remove('is-active');
      projectView.project = {};
      projectView.type = null;
      this.classList.remove('is-expanded');
      this.style.marginBottom = 0;
      projectView.onDomChange = null;
      projectViewContainer.classList.remove('is-active');
      var removeProjectViewClass;
      removeProjectViewClass = (function(){
        if (typeof callback == 'function') {
          callback();
        }
        this.removeEventListener('transitionend', removeProjectViewClass);
      }).bind(this);
      this.addEventListener('transitionend', removeProjectViewClass);
    },
    expandProjectView: function(relativeElement) {
      var projectViewContainer = document.querySelector('#projectListProjectViewContainer');
      var projectView = document.querySelector('#projectListProjectView');
      var posY = $(relativeElement).position().top + $(relativeElement).height();
      var posX = $(relativeElement).position().left + $(relativeElement).width() / 2;
      $(projectViewContainer).css({top: posY, 'transform-origin': posX+'px -130px'});

      window.scrollTop = posY;

      projectView.project = this.item;
      projectView.type = this.svg;
      this.classList.add('is-expanded');
      projectViewContainer.classList.add('is-active');
      $(this).css({marginBottom: projectView.offsetHeight + 8});

      projectView.onDomChange = (function(){
        $(this).css({marginBottom: projectView.offsetHeight + 8});
      }).bind(this);
    }
  });

</script>
