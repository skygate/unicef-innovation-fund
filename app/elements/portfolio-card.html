
<dom-module id='portfolio-card'>
  <template>
    <style>

      :host {
        border-top: 16px solid #ffcc33;
        display: flex;
        flex-direction: column;
        flex: 1;
        align-items: stretch;
        justify-content: space-between;
      }

      :host hr {
        width:90%;
        margin:16px auto 8px;
      }

      :host.portfolio-card--real-time-information {
        border-color: #ff3366;
      }

      :host.portfolio-card--infrastructure {
        border-color: #66cc66;
      }

      .top_container_in_card {
        padding-top: 16px;
      }

      .portfolio_card_title {
        margin: 0;
      }

      .pc_left{
        padding-left: 1.5rem;
        padding-right: 1.5rem;
      }

      .card_title {
         height: 30px;
         line-height: 30px;
         padding-left:5px;
       }

       circular-progress {
         display: inline-block;
       }

       .portfolio-card__progress {
         text-align: center;
         margin-bottom: 32px;
         margin-top: 16px;
       }

       .portfolio-card__progress-info {
         position: relative;
         margin-bottom: 6px;
       }

       .portfolio-card__progress-info::before {
         display: inline-block;
         content: '';
         width: 1px;
         height: 14px;
         background-color: #ffcc33;
         position: absolute;
         left: 50%;
         bottom: -16px;
       }

       .portfolio-card__progress-info--real_time_information::before {
         background-color: #ff3366;
       }

       .portfolio-card__progress-info--infrastructure::before {
         background-color: #66cc66;
       }

       .portfolio-card__progress-info--knowledge_products::before {
         background-color: #33cccc;
       }

       .portfolio-card__progress-subtitle, .portfolio-card__progress-info {
         text-transform: uppercase;
         font-size: 12px;
         color: #333333;
         line-height: 1.1em;
       }

       .portfolio-card__progress-subtitle {
         margin-top: 0.3em;
         margin-bottom: -0.5em;
       }

       progress-bubble.circular-progress__bubble--real_time_information {
         --progress-bubble-stroke-color: #ff3366;
         color: #ff3366;
       }

       progress-bubble.circular-progress__bubble--infrastructure {
         --progress-bubble-stroke-color: #66cc66;
         color: #66cc66;
       }

       progress-bubble.circular-progress__bubble--knowledge_products {
         --progress-bubble-stroke-color: #33cccc;
         color: #33cccc;
       }

    </style>

    <style is="custom-style">
      :root {
        --paper-tooltip: {
          font-size: 14px;
          width:auto;
        };
      }

      .project__switch {
          cursor: pointer;
          display: inline-block;
          font-size: 0.85rem;
          list-style-type: none;
          margin-right: 2.5rem;
          transition: all 0.5s;
          text-transform: uppercase;
      }

      .project__section {
        transition: all 0.5s ease-in-out;
      }

      @media (max-width: 840px) {
        .project__header {
            background-color: #F1F2F2;
            box-shadow: 0 -10px 0 0 var(--portfolio-card-lead-color);
            margin: 10px 0 0;
            padding-bottom: 0.6rem;
            padding-left: 1.5rem;
            padding-top: 1rem;
        }

        .project__title {
            font-size: 1.35rem;
            margin: 0;
        }

        .is-active {
            box-shadow: 0 2px 0 0 var(--portfolio-card-lead-color);
        }

        .js-active {
          opacity: 1;
          position: relative;
          transform: translateY(0);
          visibility: visible;
        }

        .js-hidden {
          opacity: 0;
          position: absolute;
          transform: translateY(10%);
          visibility: hidden;
        }

        .project__section {
            padding-bottom: 2rem;
            padding-top: 2rem;
        }

        .project__description {
          margin-bottom: 16px;
        }
      }
    </style>

    <iron-media-query query="(min-width: 700px)" query-matches="{{wide}}"></iron-media-query>
    <iron-media-query full query="print" query-matches="{{print}}"></iron-media-query>


      <div class$="{{_computeClass(wide)}}">
        <ul class="mdl-layout__cell mdl-cell--hide-desktop project__header">
            <h2 class="project__title">{{featured}}</h2>
            <li on-tap="toggleSection" class="project__switch is-active" data-active="description" data-hide="graph">Description</li>
            <li on-tap="toggleSection" class="project__switch" data-active="graph" data-hide="description">Graph</li>
        </ul>
        <div data-content="description" class="project__section js-active">
          <div class='top_container_in_card hidden--tablet'>
            <img src="/images/icons/{{svg}}.svg" width="80" style='padding-left:16px;'>
            <div class='mdl-grid'>
              <div class='mdl-cell mdl-cell--10-col title_card' style='text-align: left;'>
                <span class$='portfolio_card_title {{svg}}' >{{phrase}}</span>
              </div>
              <div class='mdl-cell mdl-cell--2-col' style='margin:0px;padding:0px;display: inline-block; vertical-align: middle; height:100% ;'>
                <!-- <paper-icon-button style="color:#0099ff; background-color:white;" class='information-tooltip' id="id_2" icon="info" alt="go back"></paper-icon-button> -->
                <img src='/images/information.png' style='position:relative; top:5px;'id="id_2" />
              </div>
            </div>
            <div>
              <paper-tooltip  class="custom" for="id_2" offset="0">{{db_tooltip}}</paper-tooltip>
            </div>
          </div>
          <div class="portfolio-card__progress">
            <div class$="portfolio-card__progress-info portfolio-card__progress-info--{{ svg }}">
              {{ _getProgressValue(progress.0) }}<br/>
              available
            </div>
            <circular-progress id="progressBar" value="[[ progress.1 ]]" max="[[ progress.0 ]]" type="[[ svg ]]">
                {{ _getProgressValue(progress.1) }}
                <span class="portfolio-card__progress-subtitle">Invested</span>
            </circular-progress>
          </div>
          <hr/>
          <div style='text-align:left;'>
            <div class$='featured {{svg}}'>
              Featured Project
            </div>
            <div class='featured_project_name pc_left'>
              {{featured}}
            </div>
            <div class='featured_project_blurb pc_left project__description'  on-tap="_handleTap"
              style='cursor:pointer;display:{{display_content}}'>
                {{featured_content}}
            </div>
          </div>
        </div>
      </div>

      <div data-content="graph" class="project__section js-hidden">
        <div class='growth_rate pc_left'>
          {{chart_description}}
        </div>
        <chart-line  data="[[prepare(svg, featured, dataSet)]]" style='width:95%; font-size:30px;padding-left:5px;'></chart-line>
        <firebase-document
          app-name="test"
          path="/content/{{tooltip_target}}"
          data="{{db_tooltip}}">
        </firebase-document>

        <firebase-document
          app-name="test"
          path="{{location_featured_content}}"
          data="{{featured_content}}">
        </firebase-document>

        <firebase-document
          app-name="test"
          path="/portfolio_projects/{{svg}}/projects_hash/{{featured_slug}}"
          data="{{featured_project}}">
        </firebase-document>

        <firebase-document
          app-name="test"
          path="{{location_featured_data}}"
          data="{{dataSet}}">
        </firebase-document>
      </div>
      <!-- <geo-ureport></geo-ureport> -->
    </div>

  </template>

</dom-module>

<script>

  // Prepare IOGT data for line chart.
  // Show user growth over time.
  function prepareIOGT(dataSet, featured, color){
    var labels = dataSet.map(function(ary){return ary[0]});
    var points = dataSet.map(function(ary){return ary[1]});

    points.map(function(e, i){
      if(i > 0){
        points[i] += points[i-1]
      }
    });

    return {
      labels: humanize_labels(labels.slice(Math.max(labels.length - 10, 1))),
      datasets:[{
        label: featured,
        backgroundColor: color,
        borderColor:"rgba(255,255,255)",
        pointBackgroundColor:"rgba(2255,255,255)",
        pointBorderColor:"#fff",
        pointHoverBackgroundColor:"#fff",
        pointHoverBorderColor:"rgba(220,220,220,1)",
        data:points.slice(Math.max(points.length - 10, 1))
      }]}
  }

  function prepareGitCommits(dataSet, featured, color){
    points_labels = gitPointsAndLabels(dataSet)
    return {labels: points_labels.labels, datasets:[{
      label: featured,
      backgroundColor: color,
      borderColor:"rgba(255,255,255)",
      pointBackgroundColor:"rgba(2255,255,255)",
      pointBorderColor:"#fff",
      pointHoverBackgroundColor:"#fff",
      pointHoverBorderColor:"rgba(220,220,220,1)",
      data:points_labels.points
    }]}
  };

  Polymer({
    is: 'portfolio-card',

    handle_response: function(request){
      this.data = request.detail.response
    },

    _handleTap:function(){
      var project = this.featured_project;
      var projectType = this.svg;
      var projectView = Polymer.dom(document.getElementById('projectView'));
      var projectModal = Polymer.dom(document.getElementById('projectModal'));

      projectView.node.project = project;
      projectView.node.type = projectType;
      projectModal.node.open();
    },
    toggleSection: function (event) {
        var activeMenuItemClass = 'is-active';
        var activeSectionClass = 'js-active';
        var inactiveSectionClass = 'js-hidden';

        var dataset = event.target.dataset;
        var clickedMenuItem = event.target;

        var toHide = this.$$('[data-content="' + dataset.hide + '"]');
        var toShow = this.$$('[data-content="' + dataset.active + '"]');
        var activeMenuItem = this.$$('.is-active');

        toHide.classList.remove(activeSectionClass);
        toHide.classList.add(inactiveSectionClass);

        toShow.classList.remove(inactiveSectionClass);
        toShow.classList.add(activeSectionClass);

        clickedMenuItem.classList.add(activeMenuItemClass);
        activeMenuItem.classList.remove(activeMenuItemClass);
    },

    properties: {

      chart_description: {
        type: String,
        notify: true
      },

      svg: {
        value: '',
        notify: true
      },

      featured_source: {
        value: '',
        notify: true
      },

      featured_slug: { // This is the project for the modal
        value: '',
        notify: true,
      },

      location_featured_data: {
        type: String,
        computed: "_computeLocation(featured_source)"
      },


      location_featured_content: {
        type: String,
        computed: "_computeLocation('content/featured_',  svg)"
      },

      featured: {
        value: '',
        notify: true
      },

      featured_content: {
        observer: '_content_arrived'
      },

      phrase: {
        value: '',
        notify: true
      },

      display_content: {
        value: 'none'
      },

      url: {
        computed: 'computeUrl(svg)'
    },

    lead: {
        type: String
    }
    },

    _content_arrived: function(obj){
      if(Object.keys(obj).length > 0){
        this.display_content = 'block';
      }

    },

    // target is 'svg' which is one of the portfolio names
    _computeLocation: function(route, target) {

      route = target ? route + target : route
      // Special case for mom connect.
      // Does not have it's own root node in firebase
      if(route == 'mom_connect'){
        return '/git/rapidpro_immu'
      }
       return route;
    },

    prepare: function(svg, featured, dataSet){
      if(Object.keys(dataSet) == 0){return;}
      // var color = ''
      // if(svg == 'youth_engagement') {
      //   color = "rgba(255, 204, 51, 0.2)";
      // }else if(svg == 'real_time_information') {
      //   color = "rgba(255, 143, 171, 0.2)";
      // }else{
      //   color = "rgba(133, 214, 133, 0.2)";
      // }

      if (svg == 'youth_engagement'){
        return prepareUreport(dataSet, featured, "rgba(255, 204, 51, 0.2)")
      }else if(svg == 'real_time_information'){
        return prepareGitCommits(dataSet, featured, "rgba(255, 143, 171, 0.2)");
      }else{
        return prepareIOGT(dataSet, featured, "rgba(133, 214, 133, 0.2)")
      }
    },

    to_mil: function(num){
      return(cleanToMil(num))
    },

    computeUrl: function(svg){
      if(svg){return "/line_chart/" + svg}
    },

    _computeClass: function(wide) {
       return (!wide) ? 'screen_narrow': 'screen_wide';
    },

    _getProgressValue: function(value) {
      return cleanToMil(value);
    }
  })



</script>
