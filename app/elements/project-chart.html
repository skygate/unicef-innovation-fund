<dom-module id='project-chart'>
  <template>
    <style>
    :host {
      height: 400px;
      width: 100%;
      position: relative;
      display: inline-block;
    }

    </style>
    <div>
      <div id="dashboard">
        <div id="chart_div"></div>
        <div id="control_div"></div>
      </div>
    </div>
  </template>
</dom-module>
<script>
Polymer({
  is: 'project-chart',
  properties: {
    data: {
      type: Object,
      observer: '_dataChange'
    },
    googleLabels: {
      type: Array,
      value: []
    },
    control: {
      type: Object,
      value: {}
    },
    dashboard: {
      type: Object,
      value: {}
    }
  },
  ready: function() {
    //this._runGoogleChart()
  },

  _dataChange: function(){
    if(Object.keys(this.data).length >0){
       this._runGoogleChart();
    }
  },

  _convertRgbaToRgb: function(rgba){
    var b = rgba.substring(5, rgba.length -1);
    var c = b.split(', ');
    return 'rgb('+c[0]+', '+c[1]+', '+c[2]+ ')'
  },

  _prepareGoogleLabels: function(labels){
    var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    return labels.map(function(l){
      var split = l.split(" ");
      var monthIdx = months.indexOf(split[0])+1;
      var month = ((monthIdx) < 10) ? ('0'+monthIdx):(monthIdx);
      var year = split[1];
      return new Date(year + '-' + month);
    })
  },

  _runGoogleChart: function() {
    var self = this;

    function drawChart() {
      var datasets = self.data.datasets[0] || self.data.datasets['0'];
      var labels = self.data.labels;
      var googleLabels = self._prepareGoogleLabels(labels);

      var data = new google.visualization.DataTable();
      data.addColumn('date', 'date');
      data.addColumn('number', datasets.label);

      datasets.googleBgColor = self._convertRgbaToRgb(datasets.backgroundColor);

      //first loop for labels then for thatasets to support multi columns...
      for(var x = 0; x < datasets.data.length; x++){
        var d = datasets.data[x];
        data.addRow([googleLabels[x], d]);
      }

      var minRange = googleLabels[1].getTime() - googleLabels[0].getTime();

      var dash = new google.visualization.Dashboard(document.getElementById('dashboard'));

      var control = new google.visualization.ControlWrapper({
        controlType: 'DateRangeFilter',
        containerId: 'control_div',

        options: {
          filterColumnIndex: 0,
          minValue: googleLabels[0],
          maxValue: googleLabels[googleLabels.length-1],
          width: '100%',
          ui: {
            label: false,
            format: {pattern: "MMM yyyy"},
            cssClass: "date-range-filter"
          }
        },
        state: {
          //last three months
          lowValue: googleLabels[googleLabels.length-4],
          highValue: googleLabels[googleLabels.length-1]
        }
      });

      self.googleLabels = googleLabels;
      self.control = control;
      google.visualization.events.addListener(self.control, 'statechange', self._controlUpdate.bind(self));


      var chart = new google.visualization.ChartWrapper({
        chartType: 'AreaChart',
        containerId: 'chart_div',
        options: {
          chartArea: {
            left: 40,
            top: 60,
            right: 0,
            width: '100%',
            height: 240
          },
          height: 360,
          colors: [datasets.googleBgColor],
          legend: {
            position: 'top',
            alignment: 'start'
          },
          width: '100%'
        }
      });

      self.chart = chart;

      function setOptions(wrapper) {
        wrapper.setOption('width', '100%');
        wrapper.setOption('chartArea.width', '80%');
      }
      setOptions(chart);

      dash.bind([control], [chart]);
      dash.draw(data);
      self.dashboard = dash;
      if (!self.dashboard.initiated) {
        self.dashboard.initiated = true;
        google.visualization.events.addListener(self.dashboard, 'ready', self._dashboardReady.bind(self));
      }
    }
    drawChart();

    $(window).on('resize', function(){
      drawChart();
    });
  },

  filterByYear: function(year) {
    this.control.setState({
      lowValue: (new Date(year, 0, 0)),
      highValue: (new Date(year, 11, 30)),
    });
    this.control.draw();
  },

  resetFilter: function() {
    var googleLabels = this.googleLabels;
    this.control.setState({
      lowValue: googleLabels[0],
      highValue: googleLabels[googleLabels.length-1]
    });
    this.control.draw();
  },

  _dashboardReady: function(e) {
    var projectView = document.getElementById('projectListProjectView');
    if (projectView && projectView._onDomChange) {
      projectView._onDomChange();
    }

    var controlContainer = this.control.getContainer();
    var controlThumbLabel = controlContainer.querySelectorAll('.google-visualization-controls-rangefilter-thumblabel');
    var controlThumb = controlContainer.querySelectorAll('.google-visualization-controls-slider-thumb');

    //Display thumb labels directly under thumbs
    controlThumb[0].appendChild(controlThumbLabel[0]);
    controlThumb[1].appendChild(controlThumbLabel[1]);
  },

  _controlUpdate: function() {
    var lowValue = this.control.getState().lowValue;
    var highValue = this.control.getState().highValue;

    var lowDate = new Date(lowValue.getFullYear(), lowValue.getMonth(), 1, 1, 1, 1);
    var highDate = new Date(highValue.getFullYear(), highValue.getMonth() + 1, 0);

    if (lowDate.getMonth() == highDate.getMonth()) {
      var highDate = new Date(highValue.getFullYear(), highValue.getMonth() + 2, 0);
    }

    this.control.setState({
      lowValue: lowDate,
      highValue: highDate
    });
    this.control.draw();
  }
})
</script>
